{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "",
  "Metadata": {},
  "Parameters": {
    "BastionAMIId": {
      "Description": "ami",
      "Type": "String"
    },

    "BastionPemKeyId": {
      "Description": "the id for ssh the bastions",
      "Type": "String",
      "Default": "bastionkp"
    },
    "BastionSGId": {
      "Description": "Bastion SG Id",
      "Type": "String"
    },

    "SubnetAId": {
      "Description": "-",
      "Type": "String"
    },

    "SubnetBId": {
      "Description": "-",
      "Type": "String"
    },

    "VPC": {
      "Description": "-",
      "Type": "String"
    }
  },
  "Mappings": {},
  "Conditions": {},
  "Resources": {
    "BastionEIP": {
      "Type": "AWS::EC2::EIP",
      "Properties": {
        "Domain": "vpc",

        "Tags": [{ "Key": "Name", "Value": "BastionEIP" }]
      }
    },

    "BastionASG": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "LaunchTemplate": {
          "LaunchTemplateId": { "Ref": "BastionlaunchTemplate" },
          "Version": 1
        },
        "MaxSize": "1",
        "MinSize": "1",
        "HealthCheckGracePeriod": 30,
        "HealthCheckType": "EC2",
        "VPCZoneIdentifier": [{ "Ref": "SubnetAId" }, { "Ref": "SubnetBId" }]
      }
    },
    "BastionlaunchTemplate": {
      "Type": "AWS::EC2::LaunchTemplate",
      "Properties": {
        "LaunchTemplateName": "BastionDevTemplate",
        "LaunchTemplateData": {
          "ImageId": { "Ref": "BastionAMIId" },
          "InstanceInitiatedShutdownBehavior": "terminate",

          "InstanceType": "t3.micro",

          "KeyName": { "Ref": "BastionPemKeyId" },
          "NetworkInterfaces": [],

          "SecurityGroupIds": [{ "Ref": "BastionSGId" }],
          "UserData": {
            "Fn::Base64": {
              "Fn::Sub": [
                "#!/bin/bash\nINSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\naws ec2 associate-address --instance-id $INSTANCE_ID --allocation-id=${EIP}",
                { "EIP": { "Ref": "BastionEIP" } }
              ]
            }
          }
        }
      }
    }
  },
  "Outputs": {}
}
