{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "",
    "Metadata": {},
    "Parameters": {},
    "Mappings": {},
    "Conditions": {},
    "Resources": {
        "LoadBalancerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "SG for load balancer nodes",
                "SecurityGroupIngress": [],
                "VpcId": {
                    "Fn::ImportValue": "VPCID"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "LoadBalancerSecurityGroup"
                    }
                ]
            }
        },
        "BastionSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "-",
                "SecurityGroupIngress": [],
                "VpcId": {
                    "Fn::ImportValue": "VPCID"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "BastionSecurityGroup"
                    }
                ]
            }
        },
        "ServerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "SG for server instances",
                "SecurityGroupIngress": [],
                "VpcId": {
                    "Fn::ImportValue": "VPCID"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "ServerSecurityGroup"
                    }
                ]
            }
        },
        "DataBaseSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "SG for rds/cache/dynamo/aurora instances",
                "SecurityGroupIngress": [],
                "VpcId": {
                    "Fn::ImportValue": "VPCID"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "DataBaseSecurityGroup"
                    }
                ]
            }
        },
        "BastionOutboundRule1": {
            "Type": "AWS::EC2::SecurityGroupEgress",
            "Properties": {
                "GroupId": {
                    "Ref": "BastionSecurityGroup"
                },
                "IpProtocol": "-1",
                "FromPort": "0",
                "ToPort": "65535",
                "CidrIp": "0.0.0.0/0"
            }
        },
        "BastionInboundRule1": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "BastionSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "22",
                "ToPort": "22",
                "CidrIp": "0.0.0.0/0"
            }
        },
        "BastionInboundRule2": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "BastionSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "5432",
                "ToPort": "5432",
                "SourceSecurityGroupId": {
                    "Ref": "DataBaseSecurityGroup"
                }
            }
        },
        "ServerInboundRule1": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "ServerSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "22",
                "ToPort": "22",
                "SourceSecurityGroupId": {
                    "Ref": "BastionSecurityGroup"
                }
            }
        },
        "ServerInboundRule2": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "ServerSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "5432",
                "ToPort": "5432",
                "SourceSecurityGroupId": {
                    "Ref": "DataBaseSecurityGroup"
                }
            }
        },
        "ServerInboundRule3": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "ServerSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "1",
                "ToPort": "65535",
                "SourceSecurityGroupId": {
                    "Ref": "LoadBalancerSecurityGroup"
                }
            }
        },
        "ServerInboundRule4": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "ServerSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "443",
                "ToPort": "443",
                "SourceSecurityGroupId": {
                    "Ref": "LoadBalancerSecurityGroup"
                }
            }
        },
        "ServerOutboundRule1": {
            "Type": "AWS::EC2::SecurityGroupEgress",
            "Properties": {
                "GroupId": {
                    "Ref": "ServerSecurityGroup"
                },
                "IpProtocol": "-1",
                "FromPort": "0",
                "ToPort": "65535",
                "CidrIp": "0.0.0.0/0"
            }
        },
        "DatabaseInboundRule1": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "DataBaseSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "22",
                "ToPort": "22",
                "SourceSecurityGroupId": {
                    "Ref": "BastionSecurityGroup"
                }
            }
        },
        "DatabaseInboundRule3": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "DataBaseSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "5432",
                "ToPort": "5432",
                "SourceSecurityGroupId": {
                    "Ref": "BastionSecurityGroup"
                }
            }
        },
        "DatabaseInboundRule2": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "DataBaseSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "5432",
                "ToPort": "5432",
                "SourceSecurityGroupId": {
                    "Ref": "ServerSecurityGroup"
                }
            }
        },
        "DatabaseInboundRule4": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "DataBaseSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "6379",
                "ToPort": "6379",
                "SourceSecurityGroupId": {
                    "Ref": "ServerSecurityGroup"
                }
            }
        },
        "DatabaseInboundRule5": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "DataBaseSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "6379",
                "ToPort": "6379",
                "SourceSecurityGroupId": {
                    "Ref": "BastionSecurityGroup"
                }
            }
        },
        "DatabaseOutboundRule1": {
            "Type": "AWS::EC2::SecurityGroupEgress",
            "Properties": {
                "GroupId": {
                    "Ref": "DataBaseSecurityGroup"
                },
                "IpProtocol": "-1",
                "FromPort": "0",
                "ToPort": "65535",
                "CidrIp": "0.0.0.0/0"
            }
        },
        "LBOutboundRule1": {
            "Type": "AWS::EC2::SecurityGroupEgress",
            "Properties": {
                "GroupId": {
                    "Ref": "LoadBalancerSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "0",
                "ToPort": "65535",
                "SourceSecurityGroupId": {
                    "Ref": "ServerSecurityGroup"
                }
            }
        },
        "LBInboundRule1": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "LoadBalancerSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "80",
                "ToPort": "80",
                "CidrIp": "0.0.0.0/0"
            }
        },
        "LBInboundRule2": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "LoadBalancerSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "443",
                "ToPort": "443",
                "CidrIp": "0.0.0.0/0"
            }
        }
    },
    "Outputs": {
        "DataBaseSecurityGroup": {
            "Value": {
                "Ref": "DataBaseSecurityGroup"
            },
            "Export": {
                "Name": "DataBaseSG"
            }
        },
        "ServerSecurityGroup": {
            "Value": {
                "Ref": "ServerSecurityGroup"
            },
            "Export": {
                "Name": "ServerSG"
            }
        },
        "BastionSecurityGroup": {
            "Value": {
                "Ref": "BastionSecurityGroup"
            },
            "Export": {
                "Name": "BastionSG"
            }
        },
        "LoadBalancerSecurityGroup": {
            "Value": {
                "Ref": "LoadBalancerSecurityGroup"
            },
            "Export": {
                "Name": "LoadBalancerSG"
            }
        }
    }
}